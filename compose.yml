services:
  web-app:
    container_name: web-app
    build:
      context: ./web-app
      dockerfile: Dockerfile
    volumes:
      - articles_data:/articles-data:ro
      - ./web-app:/app # bind mount used to develop env, need to delete when product env
      - rendered_articles:/app/rendered-articles # develop env, storage the rendered html files in docker volume
    environment:
      - ARTICLES_DIRECTORY=/articles-data
      - RENDERED_DIRECTORY=/rendered-articles
      - FLASK_APP=app.py

  articles-sync:
    container_name: articles-sync
    build:
      context: ./articles-sync
      dockerfile: Dockerfile
    volumes:
      - articles_data:/articles-data:rw
      # bind mount conainer logs folder, used to devlop env
      - ./articles-sync/logs:/var/log/personal-website
    environment:
      - GITHUB_REPO=https://github.com/hanjie-chen/PersonalArticles.git
      - REPO_BRANCH=main
      - LOG_DIR=/var/log/personal-website
  
  nginx-modsecurity:
    image: owasp/modsecurity-crs:nginx-alpine
    container_name: nginx-modsecurity
    ports:
      - "80:80"
    volumes:
      # bind mount user to dev env
      - ./nginx-modsecurity/conf.d/default.conf:/etc/nginx/templates/conf.d/default.conf.template
      - ./nginx-modsecurity/logs:/var/log/nginx
      # docker volume mount
      - rendered_articles:/usr/share/nginx/html/rendered-articles
    depends_on:
      - web-app
    environment:
      - MODSEC_AUDIT_LOG=/var/log/nginx/modsec-audit.log
      

volumes:
  articles_data: # source markdown files volume
  rendered_articles: # the html files volme which rendered form source markdown file