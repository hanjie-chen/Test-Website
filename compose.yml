services:
  # pull github articles repo once a day
  articles-sync:
    container_name: articles-sync
    build:
      context: ./articles-sync
      dockerfile: Dockerfile
    volumes:
      - source_md_articles:/articles/src:rw
    environment:
      - GITHUB_REPO=https://github.com/hanjie-chen/PersonalArticles.git
      - SOURCE_ARTICLES_DIRECTORY=/articles/src
      - REPO_BRANCH=main
      - WEB_APP_REINDEX_URL=http://web-app:5000/internal/reindex
      - REIMPORT_ARTICLES_TOKEN=${REIMPORT_ARTICLES_TOKEN}

  web-app:
    container_name: web-app
    build:
      context: ./web-app
      dockerfile: Dockerfile
    volumes:
      - rendered_html_articles:/articles/rendered
      - source_md_articles:/articles/src:ro
    environment:
      - SOURCE_ARTICLES_DIRECTORY=/articles/src
      - RENDERED_ARTICLES_DIRECTORY=/articles/rendered
      - FLASK_APP=app.py
      - APP_ENV=production
      - REIMPORT_ARTICLES_TOKEN=${REIMPORT_ARTICLES_TOKEN}
  
  nginx-modsecurity:
    image: owasp/modsecurity-crs:nginx-alpine
    container_name: nginx-modsecurity
    ports:
      - "80:80"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - ./nginx-modsecurity/conf.d/default.conf:/etc/nginx/templates/conf.d/default.conf.template
      # docker volume mount
      - rendered_html_articles:/usr/share/nginx/html/rendered-articles
    depends_on:
      - web-app
    environment:
      - MODSEC_AUDIT_LOG=/var/log/nginx/modsec-audit.log
      

volumes:
  source_md_articles: # source markdown files volume
  rendered_html_articles: # the html files volme which rendered form source markdown file
